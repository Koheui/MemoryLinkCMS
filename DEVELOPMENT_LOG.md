# MemoryLink CMS é–‹ç™ºãƒ­ã‚°

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: MemoryLink CMS
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v3.1
- **é–‹å§‹æ—¥**: 2024å¹´12æœˆ
- **ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ**: ver1.1
- **æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ**: `3f2c873` (2024-12-19)

## ğŸ¯ å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½

### âœ… å®Œäº†æ¸ˆã¿
1. **FirebaseåŸºç›¤æ§‹ç¯‰**
   - Firebase Hostingè¨­å®š (`firebase.json`)
   - Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ« (`firestore.rules`)
   - Next.jsé™çš„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š (`next.config.js`)

2. **èªè¨¼ã‚·ã‚¹ãƒ†ãƒ **
   - Firebase Auth Email/Passwordèªè¨¼
   - Firebase Auth Email Linkå®Ÿè£…
   - èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ  (`src/components/auth-form.tsx`)

3. **ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ** (`src/lib/types.ts`)
   - `ClaimRequest`: ã‚¯ãƒ¬ãƒ¼ãƒ è¦æ±‚ç®¡ç†
   - `Memory`: ãƒ¡ãƒ¢ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œï¼‰
   - `User`: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
   - `Asset`: ã‚¢ã‚»ãƒƒãƒˆç®¡ç†
   - `Tenant`: ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†
   - `LandingPage`: LPç®¡ç†
   - `AuditLog`: ç›£æŸ»ãƒ­ã‚°

4. **API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**
   - `POST /api/gate/lp-form`: LPãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†
   - `POST /api/gate/storefront`: ã‚¹ãƒˆã‚¢ãƒ•ãƒ­ãƒ³ãƒˆå‡¦ç†
   - `POST /api/claim/process-email-link`: Email Linkã‚¯ãƒ¬ãƒ¼ãƒ å‡¦ç†
   - `POST /api/claim/process-request`: é€šå¸¸ã‚¯ãƒ¬ãƒ¼ãƒ å‡¦ç†
   - `POST /api/claim/change-email`: ãƒ¡ãƒ¼ãƒ«å¤‰æ›´ãƒ»å†é€
   - `POST /api/hooks/stripe`: Stripe Webhookå‡¦ç†

5. **Firebase Admin SDKçµ±åˆ**
   - ä¸­å¤®é›†æ¨©çš„åˆæœŸåŒ– (`src/lib/firebase/admin.ts`)
   - ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯é€ä¿¡æ©Ÿèƒ½ (`src/lib/email-link-utils.ts`)
   - è¨ºæ–­ç”¨APIç¾¤ (`src/app/api/test/`)

6. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**
   - ç®¡ç†UI (`src/app/(app)/_admin/`)
   - ã‚¯ãƒ¬ãƒ¼ãƒ å‡¦ç†UI (`src/app/claim/`)
   - ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆå‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
   - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³

7. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½**
   - Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
   - ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
   - reCAPTCHAçµ±åˆ
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ
   - Stripeç½²åæ¤œè¨¼

8. **å‹•ç”»ãƒ»éŸ³å£°ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º**
   - VideoThumbnailã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
   - AudioThumbnailã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
   - HTML5 Video/Audio APIçµ±åˆ
   - Canvas APIã«ã‚ˆã‚‹ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ

## ğŸ”§ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **Framework**: Next.js 14.2.4
- **UI**: React, TypeScript
- **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: Tailwind CSS
- **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: Radix UI, Shadcn/ui
- **çŠ¶æ…‹ç®¡ç†**: React Hooks

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **Runtime**: Next.js API Routes (Serverless)
- **Database**: Firebase Firestore
- **Authentication**: Firebase Auth
- **File Storage**: Firebase Storage
- **Functions**: Firebase Cloud Functions

### ã‚¤ãƒ³ãƒ•ãƒ©
- **Hosting**: Firebase Hosting
- **Functions**: Firebase Functions
- **Monitoring**: Firebase Analytics
- **Security**: Firestore Security Rules

## ğŸ‰ å…¨å„ªå…ˆã‚¿ã‚¹ã‚¯å®Ÿè£…å®Œäº† (2024-12-19 23:55)

##### âœ… å„ªå…ˆA: ã‚²ãƒ¼ãƒˆæˆç«‹ â†’ ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯é€ä¿¡
1. **LPãƒ•ã‚©ãƒ¼ãƒ ã‚²ãƒ¼ãƒˆ** (`/api/gate/lp-form`)
   - reCAPTCHAæ¤œè¨¼ âœ…
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ1æ™‚é–“1å›ï¼‰ âœ…
   - `claimRequests`ä½œæˆ âœ…
   - Firebase Email Linké€ä¿¡ âœ…
   - ç›£æŸ»ãƒ­ã‚°è¨˜éŒ² âœ…

2. **ã‚¹ãƒˆã‚¢ãƒ•ãƒ­ãƒ³ãƒˆã‚²ãƒ¼ãƒˆ** (`/api/gate/storefront`)
   - åº—èˆ—JWTæ¤œè¨¼ âœ…
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ1æ™‚é–“1å›ï¼‰ âœ…
   - `claimRequests`ä½œæˆ âœ…
   - Firebase Email Linké€ä¿¡ âœ…
   - ç›£æŸ»ãƒ­ã‚°è¨˜éŒ² âœ…

3. **Stripe Webhook** (`/api/hooks/stripe`)
   - ç½²åæ¤œè¨¼ âœ…
   - æ±ºæ¸ˆæˆåŠŸæ™‚ã®`claimRequests`ä½œæˆ âœ…
   - Firebase Email Linké€ä¿¡ âœ…
   - ç›£æŸ»ãƒ­ã‚°è¨˜éŒ² âœ…

##### âœ… å„ªå…ˆB: å—ã‘å–ã‚Šå‡¦ç†ï¼ˆ/claimï¼‰
1. **ã‚¯ãƒ¬ãƒ¼ãƒ ãƒšãƒ¼ã‚¸æ›´æ–°**
   - Firebase Auth Email Linkå¯¾å¿œ âœ…
   - `isSignInWithEmailLink`æ¤œå‡º âœ…
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›UI âœ…
   - è¤‡æ•°ãƒ•ãƒ­ãƒ¼å¯¾å¿œ âœ…

2. **Email Linkã‚¯ãƒ¬ãƒ¼ãƒ å‡¦ç†API** (`/api/claim/process-email-link`)
   - ãƒ¡ãƒ¼ãƒ«çªåˆãƒ­ã‚¸ãƒƒã‚¯ âœ…
   - æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆ72æ™‚é–“ï¼‰ âœ…
   - ãƒ¡ãƒ¢ãƒªãƒ¼æ–°è¦ä½œæˆ âœ…
   - ç›£æŸ»ãƒ­ã‚°è¨˜éŒ² âœ…

3. **é€šå¸¸ã‚¯ãƒ¬ãƒ¼ãƒ è¦æ±‚å‡¦ç†API** (`/api/claim/process-request`)
   - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è‡´ç¢ºèª âœ…
   - ãƒ¡ãƒ¼ãƒ«çªåˆãƒ­ã‚¸ãƒƒã‚¯ âœ…
   - æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆ72æ™‚é–“ï¼‰ âœ…
   - ãƒ¡ãƒ¢ãƒªãƒ¼æ–°è¦ä½œæˆ âœ…
   - ç›£æŸ»ãƒ­ã‚°è¨˜éŒ² âœ…

##### âœ… å„ªå…ˆC: å®›å…ˆå¤‰æ›´ãƒ»å†é€
1. **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´API** (`/api/claim/change-email`)
   - reCAPTCHAæ¤œè¨¼ âœ…
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ24æ™‚é–“1å›ï¼‰ âœ…
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å±¥æ­´è¨˜éŒ² âœ…
   - æ–°ã—ã„Email Linké€ä¿¡ âœ…
   - ç›£æŸ»ãƒ­ã‚°è¨˜éŒ² âœ…

##### âœ… å„ªå…ˆD: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/å¥å…¨åŒ–
1. **Firestore Rules** âœ…
   - `claimRequests`ã¯admin/Functionsã®ã¿
   - `memories`/`assets`ã¯owner(uid) or admin
   - `publicPages`ã¯read: true / write: Functionsã®ã¿

2. **æ¤œè¨¼æ©Ÿèƒ½** âœ…
   - Stripeç½²åæ¤œè¨¼
   - reCAPTCHAæ¤œè¨¼
   - åº—èˆ—JWTæ¤œè¨¼

3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™** âœ…
   - åŒä¸€emailã¸ã®æ–°è¦é€ä¿¡ã¯1æ™‚é–“1å›
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ã¯24æ™‚é–“1å›

##### âœ… å„ªå…ˆE: ç®¡ç†UI
1. **ã‚¯ãƒ¬ãƒ¼ãƒ è¦æ±‚ç®¡ç†** (`/admin/claim-requests`)
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã‚½ãƒ¼ã‚¹ã€ãƒ†ãƒŠãƒ³ãƒˆã€LP IDãƒ•ã‚£ãƒ«ã‚¿ âœ…
   - å†é€ãƒœã‚¿ãƒ³ âœ…
   - è©³ç´°æƒ…å ±è¡¨ç¤º âœ…

2. **ç›£æŸ»ãƒ­ã‚°è¡¨ç¤º** (`/admin/audit-logs`)
   - ã‚¤ãƒ™ãƒ³ãƒˆã€ãƒ†ãƒŠãƒ³ãƒˆã€LP IDã€æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ âœ…
   - è©³ç´°ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º âœ…
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° âœ…

##### âœ… å„ªå…ˆF: æœŸé™åˆ‡ã‚Œå‡¦ç†
1. **Cloud Function** (`functions/src/expire-claims.ts`)
   - æ¯æ—¥åˆå‰2æ™‚ã«å®Ÿè¡Œ âœ…
   - 72æ™‚é–“ä»¥ä¸Šå‰ã®sentçŠ¶æ…‹ã‚’expiredã«æ›´æ–° âœ…
   - ç›£æŸ»ãƒ­ã‚°è¨˜éŒ² âœ…

## ğŸ¬ å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºæ©Ÿèƒ½å®Ÿè£…å®Œäº† (2024-12-19 24:30)

##### âœ… VideoThumbnailã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
1. **ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ**
   - HTML5 Videoè¦ç´ ã‚’ä½¿ç”¨ âœ…
   - Canvas APIã§ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒç”Ÿæˆ âœ…
   - ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å¯¾å¿œï¼ˆæ¨ªé•·ãƒ»ç¸¦é•·ï¼‰ âœ…
   - è‡ªå‹•ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ âœ…

2. **å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«**
   - å†ç”Ÿ/ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ âœ…
   - éŸ³é‡åˆ¶å¾¡ï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆï¼‰ âœ…
   - ãƒ›ãƒãƒ¼æ™‚ã®å†ç”Ÿã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ âœ…
   - å‹•ç”»çµ‚äº†æ™‚ã®è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ âœ…

##### âœ… AudioThumbnailã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
1. **è¦–è¦šçš„ãƒ‡ã‚¶ã‚¤ãƒ³**
   - éŸ³æ¥½ã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ âœ…
   - çµ±ä¸€ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ âœ…
   - ãƒ›ãƒãƒ¼æ™‚ã®å†ç”Ÿã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ âœ…

2. **éŸ³å£°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«**
   - å†ç”Ÿ/ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ âœ…
   - éŸ³é‡åˆ¶å¾¡ï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆï¼‰ âœ…
   - å†ç”Ÿæ™‚é–“è¡¨ç¤º âœ…
   - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º âœ…

##### âœ… ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ
1. **è¡¨ç¤ºå½¢å¼å¤‰æ›´**
   - å‹•ç”»ãƒ»éŸ³å£°ã‚’ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã«å¤‰æ›´ âœ…
   - ç”»åƒã¨åŒæ§˜ã®é¸æŠãƒ»ä¸€æ‹¬å‰Šé™¤æ©Ÿèƒ½ âœ…
   - çµ±ä¸€ã•ã‚ŒãŸUIãƒ‡ã‚¶ã‚¤ãƒ³ âœ…

2. **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ**
   - ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ2åˆ—ã€œ6åˆ—ï¼‰ âœ…
   - ãƒ¢ãƒã‚¤ãƒ«ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—å¯¾å¿œ âœ…

## ğŸš€ å®Ÿè£…å®Œäº†ã—ãŸæ©Ÿèƒ½
- **å®Œå…¨ãªã‚¯ãƒ¬ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼**: ã‚²ãƒ¼ãƒˆ â†’ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ â†’ ã‚¯ãƒ¬ãƒ¼ãƒ  â†’ ãƒ¡ãƒ¢ãƒªãƒ¼ä½œæˆ
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: reCAPTCHAã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€ç½²åæ¤œè¨¼
- **ç›£æŸ»ãƒ­ã‚°**: å…¨æ“ä½œã®è¿½è·¡ã¨è¨˜éŒ²
- **ç®¡ç†UI**: ã‚¯ãƒ¬ãƒ¼ãƒ è¦æ±‚ç®¡ç†ã€ç›£æŸ»ãƒ­ã‚°è¡¨ç¤º
- **è‡ªå‹•åŒ–**: æœŸé™åˆ‡ã‚Œå‡¦ç†ã€Cloud Functions
- **ãƒ¡ãƒ‡ã‚£ã‚¢ç®¡ç†**: å‹•ç”»ãƒ»éŸ³å£°ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã€ä¸€æ‹¬æ“ä½œ

## ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå¾Œè¿½ã„æ©Ÿèƒ½ï¼‰
- [ ] æœªæŠ•ç¨¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¯è¦–åŒ–ï¼ˆGoogle Sheetsé€£æºï¼‰
- [ ] ç’°å¢ƒå¤‰æ•°ã®æœ€é©åŒ–
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤

## ğŸ“ é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
MemoryLinkCMS/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ (app)/
â”‚   â”‚   â”‚   â”œâ”€â”€ _admin/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ claim-requests/page.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ audit-logs/page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ media-library/page.tsx
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ claim/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ process-email-link/route.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ process-request/route.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ change-email/route.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ gate/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ lp-form/route.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ storefront/route.ts
â”‚   â”‚   â”‚   â””â”€â”€ hooks/stripe/route.ts
â”‚   â”‚   â””â”€â”€ claim/page.tsx
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ video-thumbnail.tsx
â”‚   â”‚   â”œâ”€â”€ audio-thumbnail.tsx
â”‚   â”‚   â””â”€â”€ ui/
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ firebase/admin.ts
â”‚       â”œâ”€â”€ email-link-utils.ts
â”‚       â””â”€â”€ types.ts
â”œâ”€â”€ functions/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ index.ts
â”‚       â””â”€â”€ expire-claims.ts
â””â”€â”€ firebase.json
```

## ğŸ”— å¤–éƒ¨ãƒªãƒ³ã‚¯
- **Firebase Console**: https://console.firebase.google.com/project/memorylink-cms
- **GitHub Repository**: https://github.com/Koheui/MemoryLinkCMS.git
- **Branch**: ver1.1

---
**æœ€çµ‚æ›´æ–°**: 2024-12-19 24:30
**æ›´æ–°è€…**: Development Team